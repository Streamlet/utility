import("../build_options.gni")

# boost

config("boost_public_config") {
  defines = [ "BOOST_AUTO_LINK_SYSTEM" ]
  include_dirs = [ "boost" ]
  lib_dirs = [ "$target_gen_dir/boost/lib" ]
}

boost("boost") {
  boost_source_dir = "boost"
  boost_libraries = [
    "program_options",
    "filesystem",
  ]
  boost_install_dir = "$target_gen_dir/boost"
  boost_layout = "system"
  if (is_win) {
    boost_outputs = [
      "$target_gen_dir/boost/lib/libboost_program_options.lib",
      "$target_gen_dir/boost/lib/libboost_filesystem.lib",
    ]
  } else {
    boost_outputs = [
      "$target_gen_dir/boost/lib/libboost_program_options.a",
      "$target_gen_dir/boost/lib/libboost_filesystem.a",
    ]
  }

  public_configs = [ ":boost_public_config" ]
}

# loki

config("loki_public_config") {
  include_dirs = [ "loki/include" ]
  if (is_win) {
    cflags = [ "/wd4828" ]
  }
}

group("loki") {
  public_configs = [ ":loki_public_config" ]
}

#googletest

config("googletest_public_config") {
  include_dirs = [ "$target_gen_dir/googletest/include" ]
  lib_dirs = [ "$target_gen_dir/googletest/lib" ]
}

cmake("googletest") {
  testonly = true
  cmake_root_dir = "googletest"
  cmake_options = [
    "BUILD_GMOCK=OFF",
    "CMAKE_INSTALL_LIBDIR=lib",
  ]
  if (!is_win || !static_link_crt) {
    cmake_options += [ "googletest_force_shared_crt=ON" ]
  }
  cmake_install_dir = "$target_gen_dir/googletest"
  if (is_win) {
    cmake_outputs = [ "$target_gen_dir/googletest/lib/gtest.lib" ]
  } else {
    cmake_outputs = [ "$target_gen_dir/googletest/lib/libgtest.a" ]
  }
  public_configs = [ ":googletest_public_config" ]
}

#curl

if (is_win && !winhttp) {
  config("curl_public_config") {
    include_dirs = [ "$target_gen_dir/curl/include" ]
    lib_dirs = [ "$target_gen_dir/curl/lib" ]
    libs = [ "crypt32.lib" ]
    defines = []
    if (static_link_crt) {
      defines += [ "CURL_STATICLIB" ]
    }
  }

  makefile("curl") {
    makefile_root_dir = "curl/winbuild"
    makefile_config_cmd = ""
    makefile_prefix = "$target_gen_dir/curl"
    makefile_file = "Makefile.vc"
    makefile_targets = [ "" ]
    makefile_options = [
      "ENABLE_UNICODE=yes",
      "MACHINE=" + target_cpu,
      "mode=static",
      "WITH_PREFIX=" +
          string_replace(rebase_path("$target_gen_dir\\curl", "curl\\winbuild"),
                         "/",
                         "\\"),
    ]
    if (is_debug) {
      makefile_options += [ "DEBUG=yes" ]
    } else {
      makefile_options += [ "DEBUG=no" ]
    }
    if (static_link_crt) {
      makefile_options += [ "RTLIBCFG=static" ]
    } else {
      makefile_options += [ "RTLIBCFG=dll" ]
    }

    makefile_outputs = [
      "$target_gen_dir/curl/include/curl/curl.h",
      "$target_gen_dir/curl/bin/curl.exe",
    ]
    if (is_debug) {
      makefile_outputs += [ "$target_gen_dir/curl/lib/libcurl_a_debug.lib" ]
    } else {
      makefile_outputs += [ "$target_gen_dir/curl/lib/libcurl_a.lib" ]
    }

    public_configs = [ ":curl_public_config" ]
  }
}
if (is_posix) {
  config("curl_public_config") {
    include_dirs = [ "$target_gen_dir/curl/include" ]
    lib_dirs = [ "$target_gen_dir/curl/lib" ]
  }

  # for posix
  # install openssl-devel, zlib-devel in your system
  makefile("curl") {
    makefile_root_dir = "curl"
    makefile_prefix = "$target_gen_dir/curl"
    makefile_config_options = [ "--with-ssl" ]
    if (is_debug) {
      makefile_config_options += [ "--enable-debug" ]
    }
    makefile_outputs = [ "$target_gen_dir/curl/lib/libcurl.a" ]
    public_configs = [ ":curl_public_config" ]
  }
}

#rapidjson

config("rapidjson_public_config") {
  include_dirs = [ "rapidjson/include" ]
  defines = [ "_SILENCE_ALL_CXX17_DEPRECATION_WARNINGS" ]
}

group("rapidjson") {
  public_configs = [ ":rapidjson_public_config" ]
}

# libressl
if (is_win || is_mac) {
  config("openssl_public_config") {
    include_dirs = [ "$target_gen_dir/libressl/include" ]
    lib_dirs = [ "$target_gen_dir/libressl/lib" ]
    if (is_mac) {
      cflags = [ "-Wno-deprecated-declarations" ]
    }
    if (is_win) {
      libs = [
        "crypto-51.lib",
        "ws2_32.lib",
      ]
    } else {
      libs = [ "crypto" ]
    }
  }

  cmake("openssl") {
    cmake_root_dir = "libressl"
    cmake_options = [
      "LIBRESSL_APPS=OFF",
      "LIBRESSL_TESTS=OFF",
    ]
    if (static_link_crt) {
      cmake_options += [ "USE_STATIC_MSVC_RUNTIMES=ON" ]
    }
    cmake_install_dir = "$target_gen_dir/libressl"
    if (is_win) {
      cmake_outputs = [ "$target_gen_dir/libressl/lib/crypto-51.lib" ]
    } else {
      cmake_outputs = [ "$target_gen_dir/libressl/lib/libcrypto.a" ]
    }
    public_configs = [ ":openssl_public_config" ]
  }
}

# openssl
if (is_linux) {
  print("using openssl-devel")
  config("openssl_public_config") {
    cflags = [ "-Wno-deprecated-declarations" ]
  }
  group("openssl") {
    public_configs = [ ":openssl_public_config" ]
  }
}

# zlibwrap

config("zlibwrap_public_config") {
  include_dirs = [ "ZLibWrap/include" ]
}

group("zlibwrap") {
  public_configs = [ ":zlibwrap_public_config" ]
  deps = [ "ZLibWrap/src:zlibwrap" ]
}
