// MIT License
//
// Copyright (c) 2022 Streamlet (streamlet@outlook.com)
//
// Permission is hereby granted, free of charge, to any person obtaining a copy
// of this software and associated documentation files (the "Software"), to deal
// in the Software without restriction, including without limitation the rights
// to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
// copies of the Software, and to permit persons to whom the Software is
// furnished to do so, subject to the following conditions:
//
// The above copyright notice and this permission notice shall be included in all
// copies or substantial portions of the Software.
//
// THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
// SOFTWARE.

#pragma once

#include <list>
#include <map>
#include <memory>
#include <rapidjson/document.h>
#include <rapidjson/prettywriter.h>
#include <rapidjson/writer.h>
#include <set>
#include <string>
#include <unordered_map>
#include <unordered_set>
#if __cplusplus >= 201703L
#include <optional>
#include <string_view>

#endif
namespace xl {

namespace json {

enum WriteFlags {
  WRITE_FLAG_NONE = 0,
  WRITE_FLAG_PRETTY = 1 << 0,
  WRITE_FLAG_WRITE_NULL_VALUES = 1 << 1,
};

} // namespace json

template <typename T>
struct json_accessor {
  static bool read(T &ref, const ::rapidjson::Value &json_value) {
    return ref.json_read(json_value);
  }
  static bool will_write(const T &ref, unsigned int flags) {
    return true;
  }
  static void write(const T &ref, ::rapidjson::Writer<::rapidjson::StringBuffer> &writer, unsigned int flags) {
    ref.json_write(writer, flags);
  }
  static void
  write_pretty(const T &ref, ::rapidjson::PrettyWriter<::rapidjson::StringBuffer> &writer, unsigned int flags) {
    ref.json_write_pretty(writer, flags);
  }
};

template <>
class json_accessor<bool> {
public:
  static bool read(bool &ref, const ::rapidjson::Value &json_value) {
    if (!json_value.IsBool()) {
      return false;
    }
    ref = json_value.GetBool();
    return true;
  }
  static bool will_write(const bool &ref, unsigned int flags) {
    return true;
  }
  static void write(const bool &ref, ::rapidjson::Writer<::rapidjson::StringBuffer> &writer, unsigned int flags) {
    writer.Bool(ref);
  }
  static void
  write_pretty(const bool &ref, ::rapidjson::PrettyWriter<::rapidjson::StringBuffer> &writer, unsigned int flags) {
    writer.Bool(ref);
  }
};

#define JSON_ACCESSOR_NUMBER(type, write_type)                                                                         \
  template <>                                                                                                          \
  class json_accessor<type> {                                                                                          \
  public:                                                                                                              \
    static bool read(type &ref, const ::rapidjson::Value &json_value) {                                                \
      if (!json_value.IsNumber()) {                                                                                    \
        return false;                                                                                                  \
      }                                                                                                                \
      if (json_value.IsInt()) {                                                                                        \
        ref = (type)json_value.GetInt();                                                                               \
      } else if (json_value.IsUint()) {                                                                                \
        ref = (type)json_value.GetUint();                                                                              \
      } else if (json_value.IsInt64()) {                                                                               \
        ref = (type)json_value.GetInt64();                                                                             \
      } else if (json_value.IsUint64()) {                                                                              \
        ref = (type)json_value.GetUint64();                                                                            \
      } else if (json_value.IsFloat()) {                                                                               \
        ref = (type)json_value.GetFloat();                                                                             \
      } else if (json_value.IsDouble()) {                                                                              \
        ref = (type)json_value.GetDouble();                                                                            \
      } else {                                                                                                         \
        return false;                                                                                                  \
      }                                                                                                                \
      return true;                                                                                                     \
    }                                                                                                                  \
    static bool will_write(const type &ref, unsigned int flags) {                                                      \
      return true;                                                                                                     \
    }                                                                                                                  \
    static void write(const type &ref, ::rapidjson::Writer<::rapidjson::StringBuffer> &writer, unsigned int flags) {   \
      writer.write_type(ref);                                                                                          \
    }                                                                                                                  \
    static void                                                                                                        \
    write_pretty(const type &ref, ::rapidjson::PrettyWriter<::rapidjson::StringBuffer> &writer, unsigned int flags) {  \
      writer.write_type(ref);                                                                                          \
    }                                                                                                                  \
  }

JSON_ACCESSOR_NUMBER(char, Int);
JSON_ACCESSOR_NUMBER(unsigned char, Uint);
JSON_ACCESSOR_NUMBER(short, Int);
JSON_ACCESSOR_NUMBER(unsigned short, Uint);
JSON_ACCESSOR_NUMBER(int, Int);
JSON_ACCESSOR_NUMBER(unsigned int, Uint);
JSON_ACCESSOR_NUMBER(long, Int);
JSON_ACCESSOR_NUMBER(unsigned long, Uint);
JSON_ACCESSOR_NUMBER(long long, Int64);
JSON_ACCESSOR_NUMBER(unsigned long long, Uint64);
JSON_ACCESSOR_NUMBER(float, Double);
JSON_ACCESSOR_NUMBER(double, Double);

template <>
class json_accessor<std::string> {
public:
  static bool read(std::string &ref, const ::rapidjson::Value &json_value) {
    if (!json_value.IsString()) {
      return false;
    }
    ref.assign(json_value.GetString(), json_value.GetStringLength());
    return true;
  }
  static bool will_write(const std::string &ref, unsigned int flags) {
    return true;
  }
  static void
  write(const std::string &ref, ::rapidjson::Writer<::rapidjson::StringBuffer> &writer, unsigned int flags) {
    writer.String(ref.c_str(), (::rapidjson::SizeType)ref.size(), false);
  }
  static void write_pretty(const std::string &ref,
                           ::rapidjson::PrettyWriter<::rapidjson::StringBuffer> &writer,
                           unsigned int flags) {
    writer.String(ref.c_str(), (::rapidjson::SizeType)ref.size(), false);
  }
};

#if __cplusplus >= 201703L
template <>
class json_accessor<std::string_view> {
public:
  static bool read(std::string_view &ref, const ::rapidjson::Value &json_value) {
    if (!json_value.IsString()) {
      return false;
    }
    ref = {json_value.GetString(), json_value.GetStringLength()};
    return true;
  }
  static bool will_write(const std::string_view &ref, unsigned int flags) {
    return true;
  }
  static void
  write(const std::string_view &ref, ::rapidjson::Writer<::rapidjson::StringBuffer> &writer, unsigned int flags) {
    writer.String(ref.data(), (::rapidjson::SizeType)ref.length(), false);
  }
  static void write_pretty(const std::string_view &ref,
                           ::rapidjson::PrettyWriter<::rapidjson::StringBuffer> &writer,
                           unsigned int flags) {
    writer.String(ref.data(), (::rapidjson::SizeType)ref.length(), false);
  }
};
#endif

#define JSON_ACCESSOR_POINTER(pointer)                                                                                 \
  template <typename T>                                                                                                \
  class json_accessor<pointer<T>> {                                                                                    \
  public:                                                                                                              \
    static bool read(pointer<T> &ref, const ::rapidjson::Value &json_value) {                                          \
      if (json_value.IsNull()) {                                                                                       \
        ref.reset();                                                                                                   \
        return true;                                                                                                   \
      }                                                                                                                \
      ref = pointer<T>(new T());                                                                                       \
      return json_accessor<T>::read(*ref, json_value);                                                                 \
    }                                                                                                                  \
    static bool will_write(const pointer<T> &ref, unsigned int flags) {                                                \
      return (flags & json::WRITE_FLAG_WRITE_NULL_VALUES) != 0 ||                                                      \
             (ref != nullptr && json_accessor<T>::will_write(*ref, flags));                                            \
    }                                                                                                                  \
    static void                                                                                                        \
    write(const pointer<T> &ref, ::rapidjson::Writer<::rapidjson::StringBuffer> &writer, unsigned int flags) {         \
      if (ref == nullptr) {                                                                                            \
        writer.Null();                                                                                                 \
      } else {                                                                                                         \
        return json_accessor<T>::write(*ref, writer, flags);                                                           \
      }                                                                                                                \
    }                                                                                                                  \
    static void write_pretty(const pointer<T> &ref,                                                                    \
                             ::rapidjson::PrettyWriter<::rapidjson::StringBuffer> &writer,                             \
                             unsigned int flags) {                                                                     \
      if (ref == nullptr) {                                                                                            \
        writer.Null();                                                                                                 \
      } else {                                                                                                         \
        return json_accessor<T>::write_pretty(*ref, writer, flags);                                                    \
      }                                                                                                                \
    }                                                                                                                  \
  }

JSON_ACCESSOR_POINTER(std::unique_ptr);
JSON_ACCESSOR_POINTER(std::shared_ptr);

#if __cplusplus >= 201703L

template <typename T>
class json_accessor<std::optional<T>> {
public:
  static bool read(std::optional<T> &ref, const ::rapidjson::Value &json_value) {
    if (json_value.IsNull()) {
      ref.reset();
      return true;
    }
    ref = T();
    return json_accessor<T>::read(ref.value(), json_value);
  }
  static bool will_write(const std::optional<T> &ref, unsigned int flags) {
    return (flags & json::WRITE_FLAG_WRITE_NULL_VALUES) != 0 ||
           (ref.has_value() && json_accessor<T>::will_write(ref.value(), flags));
  }
  static void
  write(const std::optional<T> &ref, ::rapidjson::Writer<::rapidjson::StringBuffer> &writer, unsigned int flags) {
    if (!ref.has_value()) {
      writer.Null();
    } else {
      return json_accessor<T>::write(ref.value(), writer, flags);
    }
  }
  static void write_pretty(const std::optional<T> &ref,
                           ::rapidjson::PrettyWriter<::rapidjson::StringBuffer> &writer,
                           unsigned int flags) {
    if (!ref.has_value()) {
      writer.Null();
    } else {
      return json_accessor<T>::write_pretty(ref.value(), writer, flags);
    }
  }
};

#endif

#define JSON_ACCESSOR_CONTAINER(container)                                                                             \
  template <typename T>                                                                                                \
  class json_accessor<container<T>> {                                                                                  \
  public:                                                                                                              \
    static bool read(container<T> &ref, const ::rapidjson::Value &json_value) {                                        \
      if (!json_value.IsArray()) {                                                                                     \
        return false;                                                                                                  \
      }                                                                                                                \
      auto it = ref.begin();                                                                                           \
      for (::rapidjson::SizeType i = 0; i < json_value.Size(); ++i) {                                                  \
        T t;                                                                                                           \
        if (!json_accessor<T>::read(t, json_value[i])) {                                                               \
          return false;                                                                                                \
        }                                                                                                              \
        ref.insert(ref.end(), std::move(t));                                                                           \
      }                                                                                                                \
      return true;                                                                                                     \
    }                                                                                                                  \
    static bool will_write(const container<T> &ref, unsigned int flags) {                                              \
      return true;                                                                                                     \
    }                                                                                                                  \
    static void                                                                                                        \
    write(const container<T> &ref, ::rapidjson::Writer<::rapidjson::StringBuffer> &writer, unsigned int flags) {       \
      writer.StartArray();                                                                                             \
      for (const T &item : ref) {                                                                                      \
        json_accessor<T>::write(item, writer, flags);                                                                  \
      }                                                                                                                \
      writer.EndArray(rapidjson::SizeType(ref.size()));                                                                \
    }                                                                                                                  \
    static void write_pretty(const container<T> &ref,                                                                  \
                             ::rapidjson::PrettyWriter<::rapidjson::StringBuffer> &writer,                             \
                             unsigned int flags) {                                                                     \
      writer.StartArray();                                                                                             \
      for (const T &item : ref) {                                                                                      \
        json_accessor<T>::write_pretty(item, writer, flags);                                                           \
      }                                                                                                                \
      writer.EndArray(rapidjson::SizeType(ref.size()));                                                                \
    }                                                                                                                  \
  }

JSON_ACCESSOR_CONTAINER(std::vector);
JSON_ACCESSOR_CONTAINER(std::list);
JSON_ACCESSOR_CONTAINER(std::set);
JSON_ACCESSOR_CONTAINER(std::multiset);
JSON_ACCESSOR_CONTAINER(std::unordered_set);
JSON_ACCESSOR_CONTAINER(std::unordered_multiset);

#define JSON_ACCESSOR_MAP(map)                                                                                         \
  template <typename T>                                                                                                \
  class json_accessor<map<std::string, T>> {                                                                           \
  public:                                                                                                              \
    static bool read(map<std::string, T> &ref, const ::rapidjson::Value &json_value) {                                 \
      if (!json_value.IsObject()) {                                                                                    \
        return false;                                                                                                  \
      }                                                                                                                \
      for (auto it = json_value.MemberBegin(); it != json_value.MemberEnd(); ++it) {                                   \
        T t;                                                                                                           \
        if (!json_accessor<T>::read(t, it->value)) {                                                                   \
          return false;                                                                                                \
        }                                                                                                              \
        ref.insert(std::make_pair(std::string(it->name.GetString(), it->name.GetStringLength()), std::move(t)));       \
      }                                                                                                                \
      return true;                                                                                                     \
    }                                                                                                                  \
    static bool will_write(const map<std::string, T> &ref, unsigned int flags) {                                       \
      return true;                                                                                                     \
    }                                                                                                                  \
    static void write(const map<std::string, T> &ref,                                                                  \
                      ::rapidjson::Writer<::rapidjson::StringBuffer> &writer,                                          \
                      unsigned int flags) {                                                                            \
      writer.StartObject();                                                                                            \
      for (const auto &item : ref) {                                                                                   \
        if (!json_accessor<T>::will_write(item.second, flags)) {                                                       \
          continue;                                                                                                    \
        }                                                                                                              \
        writer.Key(item.first.c_str(), ::rapidjson::SizeType(item.first.length()));                                    \
        json_accessor<T>::write(item.second, writer, flags);                                                           \
      }                                                                                                                \
      writer.EndObject(rapidjson::SizeType(ref.size()));                                                               \
    }                                                                                                                  \
    static void write_pretty(const map<std::string, T> &ref,                                                           \
                             ::rapidjson::PrettyWriter<rapidjson::StringBuffer> &writer,                               \
                             unsigned int flags) {                                                                     \
      writer.StartObject();                                                                                            \
      for (const auto &item : ref) {                                                                                   \
        if (!json_accessor<T>::will_write(item.second, flags)) {                                                       \
          continue;                                                                                                    \
        }                                                                                                              \
        writer.Key(item.first.c_str(), rapidjson::SizeType(item.first.length()));                                      \
        json_accessor<T>::write_pretty(item.second, writer, flags);                                                    \
      }                                                                                                                \
      writer.EndObject(rapidjson::SizeType(ref.size()));                                                               \
    }                                                                                                                  \
  }

JSON_ACCESSOR_MAP(std::map);
JSON_ACCESSOR_MAP(std::multimap);
JSON_ACCESSOR_MAP(std::unordered_map);
JSON_ACCESSOR_MAP(std::unordered_multimap);

} // namespace xl

#define XL_JSON_BEGIN(struct_type)                                                                                     \
  struct struct_type {                                                                                                 \
  private:                                                                                                             \
    template <typename T, size_t Index>                                                                                \
    struct field_json_accessor_t;                                                                                      \
    typedef struct_type Type;                                                                                          \
    static const size_t SEQUENCE = __COUNTER__;                                                                        \
                                                                                                                       \
  public:                                                                                                              \
    template <size_t Index>                                                                                            \
    using field_json_accessor = field_json_accessor_t<struct_type, Index>;

#define XL_JSON_MEMBER(field_type, field_name)                                                                         \
public:                                                                                                                \
  field_type field_name;                                                                                               \
                                                                                                                       \
private:                                                                                                               \
  template <typename T>                                                                                                \
  struct field_json_accessor_t<T, __COUNTER__ - SEQUENCE - 1> {                                                        \
    static bool read(Type &ref, const ::rapidjson::Value &json_value) {                                                \
      if (json_value.HasMember(#field_name)) {                                                                         \
        return ::xl::json_accessor<field_type>::read(ref.field_name, json_value[#field_name]);                         \
      }                                                                                                                \
      return true;                                                                                                     \
    }                                                                                                                  \
    static bool will_write(const Type &ref, unsigned int flags) {                                                      \
      return ::xl::json_accessor<field_type>::will_write(ref.field_name, flags);                                       \
    }                                                                                                                  \
    static void write(const Type &ref, ::rapidjson::Writer<::rapidjson::StringBuffer> &writer, unsigned int flags) {   \
      if (!will_write(ref, flags)) {                                                                                   \
        return;                                                                                                        \
      }                                                                                                                \
      writer.Key(#field_name, rapidjson::SizeType(strlen(#field_name)), false);                                        \
      ::xl::json_accessor<field_type>::write(ref.field_name, writer, flags);                                           \
    }                                                                                                                  \
    static void                                                                                                        \
    write_pretty(const Type &ref, ::rapidjson::PrettyWriter<::rapidjson::StringBuffer> &writer, unsigned int flags) {  \
      if (!will_write(ref, flags)) {                                                                                   \
        return;                                                                                                        \
      }                                                                                                                \
      writer.Key(#field_name, rapidjson::SizeType(strlen(#field_name)), false);                                        \
      ::xl::json_accessor<field_type>::write_pretty(ref.field_name, writer, flags);                                    \
    }                                                                                                                  \
  };

#define XL_JSON_END()                                                                                                  \
private:                                                                                                               \
  static const size_t FIELDS = __COUNTER__ - SEQUENCE - 1;                                                             \
  template <size_t Begin, size_t End>                                                                                  \
  struct fields_json_accessor_walker {                                                                                 \
    static bool read(Type &ref, const ::rapidjson::Value &json_value) {                                                \
      if (!json_value.IsObject()) {                                                                                    \
        return false;                                                                                                  \
      }                                                                                                                \
      if (!field_json_accessor<Begin>::read(ref, json_value)) {                                                        \
        return false;                                                                                                  \
      }                                                                                                                \
      if (!fields_json_accessor_walker<Begin + 1, End>::read(ref, json_value)) {                                       \
        return false;                                                                                                  \
      }                                                                                                                \
      return true;                                                                                                     \
    }                                                                                                                  \
    static bool will_write(const Type &ref, unsigned int flags) {                                                      \
      if (field_json_accessor<Begin>::will_write(ref, flags)) {                                                        \
        return true;                                                                                                   \
      }                                                                                                                \
      return fields_json_accessor_walker<Begin + 1, End>::will_write(ref, flags);                                      \
    }                                                                                                                  \
    static void write(const Type &ref, ::rapidjson::Writer<::rapidjson::StringBuffer> &writer, unsigned int flags) {   \
      field_json_accessor<Begin>::write(ref, writer, flags);                                                           \
      fields_json_accessor_walker<Begin + 1, End>::write(ref, writer, flags);                                          \
    }                                                                                                                  \
    static void                                                                                                        \
    write_pretty(const Type &ref, ::rapidjson::PrettyWriter<::rapidjson::StringBuffer> &writer, unsigned int flags) {  \
      field_json_accessor<Begin>::write_pretty(ref, writer, flags);                                                    \
      fields_json_accessor_walker<Begin + 1, End>::write_pretty(ref, writer, flags);                                   \
    }                                                                                                                  \
  };                                                                                                                   \
  template <size_t Index>                                                                                              \
  struct fields_json_accessor_walker<Index, Index> {                                                                   \
    static bool read(Type &ref, const ::rapidjson::Value &json_value) {                                                \
      return true;                                                                                                     \
    }                                                                                                                  \
    static bool will_write(const Type &ref, unsigned int flags) {                                                      \
      return false;                                                                                                    \
    }                                                                                                                  \
    static void write(const Type &ref, ::rapidjson::Writer<::rapidjson::StringBuffer> &writer, unsigned int flags) {   \
    }                                                                                                                  \
    static void                                                                                                        \
    write_pretty(const Type &ref, ::rapidjson::PrettyWriter<::rapidjson::StringBuffer> &writer, unsigned int flags) {  \
    }                                                                                                                  \
  };                                                                                                                   \
                                                                                                                       \
private:                                                                                                               \
  friend ::xl::json_accessor<Type>;                                                                                    \
  bool json_read(const ::rapidjson::Value &json_value) {                                                               \
    return fields_json_accessor_walker<0, FIELDS>::read(*this, json_value);                                            \
  }                                                                                                                    \
  bool json_will_write(unsigned int flags) const {                                                                     \
    return fields_json_accessor_walker<0, FIELDS>::will_write(*this, flags);                                           \
  }                                                                                                                    \
  void json_write(::rapidjson::Writer<::rapidjson::StringBuffer> &writer, unsigned int flags) const {                  \
    writer.StartObject();                                                                                              \
    fields_json_accessor_walker<0, FIELDS>::write(*this, writer, flags);                                               \
    writer.EndObject(FIELDS);                                                                                          \
  }                                                                                                                    \
  void json_write_pretty(::rapidjson::PrettyWriter<::rapidjson::StringBuffer> &writer, unsigned int flags) const {     \
    writer.StartObject();                                                                                              \
    fields_json_accessor_walker<0, FIELDS>::write_pretty(*this, writer, flags);                                        \
    writer.EndObject(FIELDS);                                                                                          \
  }                                                                                                                    \
                                                                                                                       \
public:                                                                                                                \
  bool json_parse(const char *json_string) {                                                                           \
    ::rapidjson::Document doc;                                                                                         \
    doc.Parse<::rapidjson::kParseFullPrecisionFlag | ::rapidjson::kParseCommentsFlag |                                 \
              ::rapidjson::kParseTrailingCommasFlag>(json_string);                                                     \
    if (doc.HasParseError()) {                                                                                         \
      return false;                                                                                                    \
    }                                                                                                                  \
    if (!json_read(doc)) {                                                                                             \
      return false;                                                                                                    \
    }                                                                                                                  \
    return true;                                                                                                       \
  }                                                                                                                    \
  std::string json_dump(unsigned int flags = ::xl::json::WRITE_FLAG_NONE) {                                            \
    ::rapidjson::StringBuffer sb;                                                                                      \
    if ((flags & ::xl::json::WRITE_FLAG_PRETTY) != 0) {                                                                \
      flags &= ~::xl::json::WRITE_FLAG_PRETTY;                                                                         \
      ::rapidjson::PrettyWriter<::rapidjson::StringBuffer> writer(sb);                                                 \
      json_write_pretty(writer, flags);                                                                                \
    } else {                                                                                                           \
      ::rapidjson::Writer<::rapidjson::StringBuffer> writer(sb);                                                       \
      json_write(writer, flags);                                                                                       \
    }                                                                                                                  \
    return sb.GetString();                                                                                             \
  }                                                                                                                    \
  }                                                                                                                    \
  ;
